<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Morettiflix - Gratis</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        body {
            background: linear-gradient(135deg, #1a202c 0%, #0f172a 100%);
            color: white;
            font-family: 'Montserrat', sans-serif;
        }
        .video-container {
            position: relative;
            overflow: hidden;
            border-radius: 1rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            background: rgba(0, 0, 0, 0.3);
        }
        video {
            width: 100%;
            height: auto;
            display: block;
            border-radius: 1rem;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-online {
            background-color: #10B981;
            box-shadow: 0 0 10px #10B981;
            animation: blink 1.5s infinite;
        }
        .status-offline {
            background-color: #EF4444;
            box-shadow: 0 0 10px #EF4444;
        }
        .status-loading {
            background-color: #F59E0B;
            box-shadow: 0 0 10px #F59E0B;
            animation: pulse 1s infinite;
        }
        .status-error {
            background-color: #DC2626;
            box-shadow: 0 0 10px #DC2626;
        }
        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0.4; }
            100% { opacity: 1; }
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
        .error-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 1rem;
            text-align: center;
            z-index: 10;
        }
        .retry-button {
            background: linear-gradient(45deg, #3B82F6, #10B981);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            font-weight: bold;
            transition: transform 0.2s;
        }
        .retry-button:hover {
            transform: scale(1.05);
        }
        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #3B82F6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 10px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .country-section {
            margin-bottom: 1rem;
        }
        .country-header {
            background: linear-gradient(45deg, #4F46E5, #7C3AED);
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            font-weight: bold;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .country-header:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
        }
        .country-flag {
            margin-right: 10px;
            font-size: 1.2em;
        }
        .channel-count {
            margin-left: auto;
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
        }
        .channels-container {
            max-height: 400px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 10px;
        }
        .channel-item {
            padding: 8px 12px;
            margin: 2px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
        }
        .channel-item:hover {
            background: rgba(59, 130, 246, 0.3);
            transform: translateX(3px);
        }
        .channel-item.selected {
            background: rgba(16, 185, 129, 0.4);
            border-left: 4px solid #10B981;
        }
        .channel-logo {
            width: 24px;
            height: 24px;
            margin-right: 10px;
            border-radius: 4px;
            object-fit: cover;
        }
        .channel-category {
            margin-left: auto;
            font-size: 0.7em;
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 6px;
            border-radius: 8px;
        }
        .search-container {
            margin-bottom: 1rem;
        }
        .search-input {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 14px;
        }
        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        .controls-row {
            display: flex;
            gap: 10px;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        .control-button {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid rgba(59, 130, 246, 0.4);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }
        .control-button:hover {
            background: rgba(59, 130, 246, 0.4);
        }
        .stats-container {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 1rem;
            text-align: center;
            font-size: 14px;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">
    <header class="mb-8 text-center">
        <h1 class="text-4xl font-bold mb-2 gradient-text bg-clip-text text-transparent bg-gradient-to-r from-blue-500 to-green-400">Morettiflix - Gratis</h1>
        <p class="text-lg text-gray-300">Miles de canales internacionales en vivo</p>
    </header>

    <main class="w-full max-w-7xl px-4">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Panel de Canales -->
            <div class="lg:col-span-1">
                <div class="search-container">
                    <input type="text" id="searchInput" class="search-input" placeholder="ğŸ” Buscar canales...">
                </div>
                
                <div class="controls-row">
                    <button class="control-button" onclick="showAllChannels()">ğŸ“º Todos</button>
                    <button class="control-button" onclick="showFavorites()">â­ Favoritos</button>
                    <button class="control-button" onclick="refreshChannels()">ğŸ”„ Actualizar</button>
                </div>

                <div class="stats-container">
                    <div id="statsInfo">Cargando canales...</div>
                </div>

                <div id="channelsPanel" class="channels-container">
                    <div class="text-center text-gray-400">Cargando canales internacionales...</div>
                </div>
            </div>

            <!-- Panel de Video -->
            <div class="lg:col-span-2">
                <div id="channelDescription" class="text-sm text-gray-300 mb-4"></div>

                <div class="video-container mb-8">
                    <video id="video" controls class="w-full" preload="metadata" poster="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 300'%3E%3Crect width='400' height='300' fill='%23111827'/%3E%3Ctext x='200' y='150' text-anchor='middle' fill='%23374151' font-size='24'%3ESelecciona un canal%3C/text%3E%3C/svg%3E"></video>
                    <div id="errorOverlay" class="error-overlay" style="display: none;">
                        <div>
                            <h3 class="text-xl font-bold mb-2">âš ï¸ Error de ReproducciÃ³n</h3>
                            <p id="errorMessage" class="text-gray-300 mb-4">Problema al cargar el canal</p>
                            <div class="loading-spinner" id="loadingSpinner" style="display: none;"></div>
                            <button class="retry-button" onclick="retryCurrentChannel()">ğŸ”„ Reintentar</button>
                            <button class="retry-button" onclick="tryNextChannel()">â­ï¸ Siguiente Canal</button>
                            <button class="retry-button" onclick="tryRandomChannel()">ğŸ² Canal Aleatorio</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const video = document.getElementById('video');
        const channelsPanel = document.getElementById('channelsPanel');
        const channelDescription = document.getElementById('channelDescription');
        const errorOverlay = document.getElementById('errorOverlay');
        const errorMessage = document.getElementById('errorMessage');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const searchInput = document.getElementById('searchInput');
        const statsInfo = document.getElementById('statsInfo');

        let allChannels = [];
        let channelsByCountry = {};
        let filteredChannels = [];
        let currentChannel = null;
        let currentHls = null;
        let retryCount = 0;
        let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
        
        const maxRetries = 3;
        const LOAD_TIMEOUT = 15000;
        const RETRY_DELAY = 2000;

        // Mapeo de cÃ³digos de paÃ­s a nombres y banderas
        const countryInfo = {
            'ar': { name: 'Argentina', flag: 'ğŸ‡¦ğŸ‡·' },
            'bo': { name: 'Bolivia', flag: 'ğŸ‡§ğŸ‡´' },
            'br': { name: 'Brasil', flag: 'ğŸ‡§ğŸ‡·' },
            'cl': { name: 'Chile', flag: 'ğŸ‡¨ğŸ‡±' },
            'co': { name: 'Colombia', flag: 'ğŸ‡¨ğŸ‡´' },
            'cr': { name: 'Costa Rica', flag: 'ğŸ‡¨ğŸ‡·' },
            'cu': { name: 'Cuba', flag: 'ğŸ‡¨ğŸ‡º' },
            'do': { name: 'Rep. Dominicana', flag: 'ğŸ‡©ğŸ‡´' },
            'ec': { name: 'Ecuador', flag: 'ğŸ‡ªğŸ‡¨' },
            'es': { name: 'EspaÃ±a', flag: 'ğŸ‡ªğŸ‡¸' },
            'gt': { name: 'Guatemala', flag: 'ğŸ‡¬ğŸ‡¹' },
            'hn': { name: 'Honduras', flag: 'ğŸ‡­ğŸ‡³' },
            'mx': { name: 'MÃ©xico', flag: 'ğŸ‡²ğŸ‡½' },
            'ni': { name: 'Nicaragua', flag: 'ğŸ‡³ğŸ‡®' },
            'pa': { name: 'PanamÃ¡', flag: 'ğŸ‡µğŸ‡¦' },
            'pe': { name: 'PerÃº', flag: 'ğŸ‡µğŸ‡ª' },
            'pr': { name: 'Puerto Rico', flag: 'ğŸ‡µğŸ‡·' },
            'py': { name: 'Paraguay', flag: 'ğŸ‡µğŸ‡¾' },
            'sv': { name: 'El Salvador', flag: 'ğŸ‡¸ğŸ‡»' },
            'uy': { name: 'Uruguay', flag: 'ğŸ‡ºğŸ‡¾' },
            've': { name: 'Venezuela', flag: 'ğŸ‡»ğŸ‡ª' },
            'us': { name: 'Estados Unidos', flag: 'ğŸ‡ºğŸ‡¸' }
        };

        async function loadChannels() {
            try {
                updateStats('Descargando lista de canales...');
                
                const response = await fetch('https://iptv-org.github.io/iptv/languages/spa.m3u', {
                    cache: 'no-cache'
                });
                
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                
                const m3uContent = await response.text();
                parseM3UContent(m3uContent);
                organizeChannelsByCountry();
                renderChannelsPanel();
                updateStats();
                
            } catch (error) {
                console.error('Error loading channels:', error);
                showError(`Error cargando canales: ${error.message}`);
                updateStats('Error cargando canales');
            }
        }

        function parseM3UContent(content) {
            allChannels = [];
            const lines = content.split('\n');
            let currentChannel = null;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                if (line.startsWith('#EXTINF:')) {
                    currentChannel = parseExtInf(line);
                } else if (line && !line.startsWith('#') && currentChannel) {
                    currentChannel.url = line;
                    if (isValidChannel(currentChannel)) {
                        allChannels.push({ ...currentChannel });
                    }
                    currentChannel = null;
                }
            }
            
            // Filtrar canales duplicados por URL
            const uniqueUrls = new Set();
            allChannels = allChannels.filter(channel => {
                if (uniqueUrls.has(channel.url)) {
                    return false;
                }
                uniqueUrls.add(channel.url);
                return true;
            });
            
            console.log(`Cargados ${allChannels.length} canales Ãºnicos`);
        }

        function parseExtInf(line) {
            const channel = {
                name: '',
                logo: '',
                group: '',
                country: '',
                category: '',
                url: ''
            };
            
            // Extraer informaciÃ³n del formato #EXTINF:-1 tvg-logo="..." group-title="..." tvg-country="...",Nombre del Canal
            const logoMatch = line.match(/tvg-logo="([^"]*)"/);
            const groupMatch = line.match(/group-title="([^"]*)"/);
            const countryMatch = line.match(/tvg-country="([^"]*)"/);
            const nameMatch = line.match(/,(.*)$/);
            
            if (logoMatch) channel.logo = logoMatch[1];
            if (groupMatch) channel.group = groupMatch[1];
            if (countryMatch) {
                const countries = countryMatch[1].toLowerCase().split(';');
                channel.country = countries[0] || '';
            }
            if (nameMatch) channel.name = nameMatch[1].trim();
            
            channel.category = channel.group || 'General';
            
            return channel;
        }

        function isValidChannel(channel) {
            return channel.name && 
                   channel.url && 
                   channel.url.startsWith('http') &&
                   !channel.name.toLowerCase().includes('test') &&
                   channel.name.length > 1;
        }

        function organizeChannelsByCountry() {
            channelsByCountry = {};
            
            allChannels.forEach(channel => {
                const countryCode = channel.country || 'unknown';
                if (!channelsByCountry[countryCode]) {
                    channelsByCountry[countryCode] = [];
                }
                channelsByCountry[countryCode].push(channel);
            });
            
            // Ordenar canales dentro de cada paÃ­s
            Object.keys(channelsByCountry).forEach(country => {
                channelsByCountry[country].sort((a, b) => a.name.localeCompare(b.name));
            });
        }

        function renderChannelsPanel() {
            channelsPanel.innerHTML = '';
            
            const countries = Object.keys(channelsByCountry).sort((a, b) => {
                // Priorizar paÃ­ses de habla hispana
                const priority = ['mx', 'es', 'ar', 'co', 'pe', 'cl', 've', 'ec'];
                const aIndex = priority.indexOf(a);
                const bIndex = priority.indexOf(b);
                
                if (aIndex !== -1 && bIndex !== -1) return aIndex - bIndex;
                if (aIndex !== -1) return -1;
                if (bIndex !== -1) return 1;
                
                const aName = countryInfo[a]?.name || a;
                const bName = countryInfo[b]?.name || b;
                return aName.localeCompare(bName);
            });
            
            countries.forEach(countryCode => {
                const channels = channelsByCountry[countryCode];
                if (channels.length === 0) return;
                
                const countryData = countryInfo[countryCode] || { 
                    name: countryCode.toUpperCase(), 
                    flag: 'ğŸŒ' 
                };
                
                const countrySection = document.createElement('div');
                countrySection.className = 'country-section';
                
                const countryHeader = document.createElement('div');
                countryHeader.className = 'country-header';
                countryHeader.innerHTML = `
                    <span class="country-flag">${countryData.flag}</span>
                    <span>${countryData.name}</span>
                    <span class="channel-count">${channels.length}</span>
                `;
                
                const channelsContainer = document.createElement('div');
                channelsContainer.style.display = 'none';
                channelsContainer.className = 'channels-list';
                
                channels.forEach(channel => {
                    const channelItem = document.createElement('div');
                    channelItem.className = 'channel-item';
                    channelItem.dataset.channelUrl = channel.url;
                    
                    const isFavorite = favorites.includes(channel.url);
                    const favoriteIcon = isFavorite ? 'â­' : 'â˜†';
                    
                    channelItem.innerHTML = `
                        ${channel.logo ? `<img src="${channel.logo}" class="channel-logo" onerror="this.style.display='none'">` : '<div style="width:24px;margin-right:10px;">ğŸ“º</div>'}
                        <span style="flex: 1;">${channel.name}</span>
                        <span class="channel-category">${channel.category}</span>
                        <span style="margin-left: 8px; cursor: pointer;" onclick="toggleFavorite('${channel.url}', event)">${favoriteIcon}</span>
                    `;
                    
                    channelItem.addEventListener('click', (e) => {
                        if (!e.target.onclick) { // No activar si se clickeÃ³ el favorito
                            selectChannel(channel);
                        }
                    });
                    
                    channelsContainer.appendChild(channelItem);
                });
                
                countryHeader.addEventListener('click', () => {
                    const isVisible = channelsContainer.style.display !== 'none';
                    channelsContainer.style.display = isVisible ? 'none' : 'block';
                    countryHeader.style.transform = isVisible ? 'none' : 'rotate(2deg)';
                });
                
                countrySection.appendChild(countryHeader);
                countrySection.appendChild(channelsContainer);
                channelsPanel.appendChild(countrySection);
            });
        }

        function selectChannel(channel) {
            // Remover selecciÃ³n anterior
            document.querySelectorAll('.channel-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Marcar canal actual
            const channelItem = document.querySelector(`[data-channel-url="${channel.url}"]`);
            if (channelItem) {
                channelItem.classList.add('selected');
            }
            
            currentChannel = channel;
            retryCount = 0;
            updateChannelInfo(channel);
            hideError();
            loadChannel(channel);
        }

        function updateChannelInfo(channel) {
            const countryData = countryInfo[channel.country] || { name: 'Internacional', flag: 'ğŸŒ' };
            
            channelDescription.innerHTML = `
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-lg font-bold">${channel.name}</h3>
                    <span class="text-sm">${countryData.flag} ${countryData.name}</span>
                </div>
                <div class="flex items-center text-sm">
                    <span class="status-indicator status-loading"></span>
                    <strong>Estado:</strong> <span id="statusText">Conectando...</span>
                    <span class="ml-4"><strong>CategorÃ­a:</strong> ${channel.category}</span>
                </div>
            `;
        }

        function updateStatus(status, text) {
            const statusIndicator = channelDescription.querySelector('.status-indicator');
            const statusText = document.getElementById('statusText');
            
            if (statusIndicator) {
                statusIndicator.className = `status-indicator status-${status}`;
            }
            if (statusText) {
                statusText.textContent = text;
            }
        }

        function loadChannel(channel) {
            return new Promise((resolve, reject) => {
                updateStatus('loading', 'Conectando...');
                hideError();

                const loadTimeout = setTimeout(() => {
                    reject(new Error('Tiempo de espera agotado'));
                }, LOAD_TIMEOUT);

                const onSuccess = () => {
                    clearTimeout(loadTimeout);
                    retryCount = 0;
                    updateStatus('online', 'En vivo');
                    resolve();
                };

                const onError = (error) => {
                    clearTimeout(loadTimeout);
                    reject(error);
                };

                playChannel(channel.url, onSuccess, onError);
            });
        }

        function playChannel(url, onSuccess, onError) {
            cleanupVideo();

            if (!url) {
                onError(new Error('URL del canal no disponible'));
                return;
            }

            try {
                if (Hls.isSupported()) {
                    playHlsStream(url, onSuccess, onError);
                } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                    playNativeStream(url, onSuccess, onError);
                } else {
                    onError(new Error('Formato de video no soportado'));
                }
            } catch (error) {
                onError(error);
            }
        }

        function playHlsStream(url, onSuccess, onError) {
            const hls = new Hls({
                enableWorker: true,
                lowLatencyMode: true,
                backBufferLength: 90,
                maxBufferLength: 30,
                manifestLoadingTimeOut: 10000,
                manifestLoadingMaxRetry: 3,
                levelLoadingTimeOut: 10000,
                fragLoadingTimeOut: 20000,
                fragLoadingMaxRetry: 6
            });

            currentHls = hls;
            hls.loadSource(url);
            hls.attachMedia(video);

            let manifestLoaded = false;

            hls.on(Hls.Events.MANIFEST_PARSED, () => {
                manifestLoaded = true;
                video.play()
                    .then(() => onSuccess())
                    .catch(() => onSuccess());
            });

            hls.on(Hls.Events.ERROR, (event, data) => {
                console.error("HLS Error:", data);
                
                if (data.fatal) {
                    switch(data.type) {
                        case Hls.ErrorTypes.MEDIA_ERROR:
                            try {
                                hls.recoverMediaError();
                                return;
                            } catch (e) {
                                onError(new Error(`Error de media: ${data.details}`));
                            }
                            break;
                        case Hls.ErrorTypes.NETWORK_ERROR:
                            try {
                                hls.startLoad();
                                return;
                            } catch (e) {
                                onError(new Error(`Error de red: ${data.details}`));
                            }
                            break;
                        default:
                            onError(new Error(`Error fatal: ${data.details || 'Desconocido'}`));
                    }
                } else if (!manifestLoaded) {
                    onError(new Error(`Error cargando stream: ${data.details}`));
                }
            });

            setTimeout(() => {
                if (!manifestLoaded) {
                    onError(new Error('Timeout cargando stream'));
                }
            }, LOAD_TIMEOUT);
        }

        function playNativeStream(url, onSuccess, onError) {
            video.src = url;
            
            const onCanPlay = () => {
                video.removeEventListener('canplay', onCanPlay);
                video.removeEventListener('error', onVideoError);
                video.play()
                    .then(() => onSuccess())
                    .catch(() => onSuccess());
            };
            
            const onVideoError = () => {
                video.removeEventListener('canplay', onCanPlay);
                video.removeEventListener('error', onVideoError);
                onError(new Error('Error cargando video nativo'));
            };
            
            video.addEventListener('canplay', onCanPlay);
            video.addEventListener('error', onVideoError);
            video.load();
        }

        function cleanupVideo() {
            if (currentHls) {
                currentHls.destroy();
                currentHls = null;
            }
            video.removeAttribute('src');
            video.load();
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorOverlay.style.display = 'flex';
            updateStatus('error', 'Error de conexiÃ³n');
        }

        function hideError() {
            errorOverlay.style.display = 'none';
            loadingSpinner.style.display = 'none';
        }

        function showLoading() {
            loadingSpinner.style.display = 'block';
        }

        function hideLoading() {
            loadingSpinner.style.display = 'none';
        }

        async function retryCurrentChannel() {
            if (!currentChannel) return;
            
            if (retryCount >= maxRetries) {
                showError('MÃ¡ximo de reintentos alcanzado');
                return;
            }

            retryCount++;
            showLoading();
            updateStatus('loading', `Reintentando (${retryCount}/${maxRetries})...`);

            try {
                await new Promise(resolve => setTimeout(resolve, RETRY_DELAY));
                await loadChannel(currentChannel);
                hideError();
            } catch (error) {
                hideLoading();
                if (retryCount >= maxRetries) {
                    showError(`Canal no disponible despuÃ©s de ${maxRetries} intentos`);
                } else {
                    showError(`Intento ${retryCount} fallÃ³`);
                }
            }
        }

        function tryNextChannel() {
            if (!currentChannel) return;
            
            const currentCountryChannels = channelsByCountry[currentChannel.country] || [];
            const currentIndex = currentCountryChannels.findIndex(ch => ch.url === currentChannel.url);
            
            if (currentIndex !== -1 && currentIndex < currentCountryChannels.length - 1) {
                selectChannel(currentCountryChannels[currentIndex + 1]);
            } else {
                // Buscar el primer canal del siguiente paÃ­s
                const countries = Object.keys(channelsByCountry);
                const currentCountryIndex = countries.indexOf(currentChannel.country);
                const nextCountryIndex = (currentCountryIndex + 1) % countries.length;
                const nextCountryChannels = channelsByCountry[countries[nextCountryIndex]];
                
                if (nextCountryChannels && nextCountryChannels.length > 0) {
                    selectChannel(nextCountryChannels[0]);
                }
            }
        }

        function tryRandomChannel() {
            const randomChannel = allChannels[Math.floor(Math.random() * allChannels.length)];
            selectChannel(randomChannel);
        }

        function toggleFavorite(channelUrl, event) {
            event.stopPropagation();
            
            const index = favorites.indexOf(channelUrl);
            if (index > -1) {
                favorites.splice(index, 1);
            } else {
                favorites.push(channelUrl);
            }
            
            localStorage.setItem('favorites', JSON.stringify(favorites));
            
            // Actualizar el panel de canales para reflejar los cambios de favoritos
            renderChannelsPanel();

            // Si el canal que acabas de marcar o desmarcar estÃ¡ seleccionado, actualizar su estado visual
            if (currentChannel && currentChannel.url === channelUrl) {
                updateChannelInfo(currentChannel);
            }
        }

        function showAllChannels() {
            filteredChannels = allChannels;
            renderChannelsPanel();
            updateStats();
        }

        function showFavorites() {
            filteredChannels = allChannels.filter(ch => favorites.includes(ch.url));
            renderChannelsPanel();
            updateStats(true);
        }

        function refreshChannels() {
            loadChannels();
        }

        searchInput.addEventListener('input', () => {
            const query = searchInput.value.toLowerCase();
            if (!query) {
                renderChannelsPanel();
                updateStats();
                return;
            }
            filteredChannels = allChannels.filter(channel => 
                channel.name.toLowerCase().includes(query) || 
                channel.category.toLowerCase().includes(query) || 
                (channel.country && countryInfo[channel.country]?.name.toLowerCase().includes(query))
            );

            renderChannelsPanel(filteredChannels);
            updateStats(false, filteredChannels.length);
        });

        // Modificar renderChannelsPanel para aceptar lista filtrada opcional
        function renderChannelsPanel(channelsList = null) {
            channelsPanel.innerHTML = '';

            const channelsToRender = channelsList || allChannels;

            // Organizar los canales filtrados por paÃ­s
            const grouped = {};

            channelsToRender.forEach(channel => {
                const countryCode = channel.country || 'unknown';
                if (!grouped[countryCode]) grouped[countryCode] = [];
                grouped[countryCode].push(channel);
            });

            const countries = Object.keys(grouped).sort((a, b) => {
                const priority = ['mx', 'es', 'ar', 'co', 'pe', 'cl', 've', 'ec'];
                const aIndex = priority.indexOf(a);
                const bIndex = priority.indexOf(b);

                if (aIndex !== -1 && bIndex !== -1) return aIndex - bIndex;
                if (aIndex !== -1) return -1;
                if (bIndex !== -1) return 1;

                const aName = countryInfo[a]?.name || a;
                const bName = countryInfo[b]?.name || b;
                return aName.localeCompare(bName);
            });

            countries.forEach(countryCode => {
                const channels = grouped[countryCode];
                if (!channels || channels.length === 0) return;

                const countryData = countryInfo[countryCode] || {
                    name: countryCode.toUpperCase(),
                    flag: 'ğŸŒ'
                };

                const countrySection = document.createElement('div');
                countrySection.className = 'country-section';

                const countryHeader = document.createElement('div');
                countryHeader.className = 'country-header';
                countryHeader.innerHTML = `
                    <span class="country-flag">${countryData.flag}</span>
                    <span>${countryData.name}</span>
                    <span class="channel-count">${channels.length}</span>
                `;

                const channelsContainer = document.createElement('div');
                channelsContainer.style.display = 'none';
                channelsContainer.className = 'channels-list';

                channels.forEach(channel => {
                    const channelItem = document.createElement('div');
                    channelItem.className = 'channel-item';
                    channelItem.dataset.channelUrl = channel.url;

                    const isFavorite = favorites.includes(channel.url);
                    const favoriteIcon = isFavorite ? 'â­' : 'â˜†';

                    channelItem.innerHTML = `
                        ${channel.logo ? `<img src="${channel.logo}" class="channel-logo" onerror="this.style.display='none'">` : '<div style="width:24px;margin-right:10px;">ğŸ“º</div>'}
                        <span style="flex: 1;">${channel.name}</span>
                        <span class="channel-category">${channel.category}</span>
                        <span style="margin-left: 8px; cursor: pointer;" onclick="toggleFavorite('${channel.url}', event)">${favoriteIcon}</span>
                    `;

                    channelItem.addEventListener('click', (e) => {
                        if (!e.target.onclick) {
                            selectChannel(channel);
                        }
                    });

                    channelsContainer.appendChild(channelItem);
                });

                countryHeader.addEventListener('click', () => {
                    const isVisible = channelsContainer.style.display !== 'none';
                    channelsContainer.style.display = isVisible ? 'none' : 'block';
                    countryHeader.style.transform = isVisible ? 'none' : 'rotate(2deg)';
                });

                countrySection.appendChild(countryHeader);
                countrySection.appendChild(channelsContainer);
                channelsPanel.appendChild(countrySection);
            });
        }

        function updateStats(isFavorites = false, filteredCount = null) {
            let total = allChannels.length;
            let visibleCount = filteredCount !== null ? filteredCount : total;
            let favCount = favorites.length;

            if (isFavorites) {
                statsInfo.textContent = `â­ Mostrando ${visibleCount} canales favoritos de un total de ${total} canales.`;
            } else if (searchInput.value.trim()) {
                statsInfo.textContent = `ğŸ” Resultados de bÃºsqueda: ${visibleCount} canales encontrados de un total de ${total}.`;
            } else {
                statsInfo.textContent = `ğŸ“º Total de canales disponibles: ${total}. â­ Favoritos: ${favCount}.`;
            }
        }

        // Inicializar todo al cargar la pÃ¡gina
        loadChannels();

    </script>
</body>
</html>
