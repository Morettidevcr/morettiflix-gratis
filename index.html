<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Morettiflix - Gratis</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hls.js/1.4.12/hls.min.js"></script>
    <style>
        :root {
            --primary-bg: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            --secondary-bg: rgba(15, 15, 35, 0.8);
            --accent-color: #00d4aa;
            --accent-hover: #00b894;
            --error-color: #ff6b6b;
            --warning-color: #feca57;
            --success-color: #48cae4;
        }

        body {
            background: var(--primary-bg);
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
        }

        .neon-text {
            text-shadow: 0 0 10px var(--accent-color), 0 0 20px var(--accent-color), 0 0 40px var(--accent-color);
        }

        .video-container {
            position: relative;
            overflow: hidden;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0, 212, 170, 0.2);
            background: var(--secondary-bg);
            transition: all 0.3s ease;
        }

        .video-container:hover {
            transform: scale(1.02);
            box-shadow: 0 35px 70px rgba(0, 212, 170, 0.3);
        }

        video {
            width: 100%;
            height: auto;
            display: block;
            border-radius: 20px;
            min-height: 400px;
            background: #000;
        }

        .status-indicator {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 10px;
            transition: all 0.3s ease;
        }

        .status-online {
            background: var(--success-color);
            box-shadow: 0 0 15px var(--success-color);
            animation: pulse-success 2s infinite;
        }

        .status-offline {
            background: var(--error-color);
            box-shadow: 0 0 15px var(--error-color);
        }

        .status-loading {
            background: var(--warning-color);
            box-shadow: 0 0 15px var(--warning-color);
            animation: pulse-warning 1s infinite;
        }

        .status-error {
            background: var(--error-color);
            box-shadow: 0 0 15px var(--error-color);
            animation: flash 0.5s infinite;
        }

        @keyframes pulse-success {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.2); }
        }

        @keyframes pulse-warning {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .error-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 20px;
            text-align: center;
            z-index: 10;
            backdrop-filter: blur(5px);
        }

        .modern-button {
            background: linear-gradient(45deg, var(--accent-color), var(--accent-hover));
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            margin: 5px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 212, 170, 0.3);
        }

        .modern-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 212, 170, 0.5);
            background: linear-gradient(45deg, var(--accent-hover), var(--accent-color));
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 15px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .country-section {
            margin-bottom: 1rem;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .country-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 18px;
            border-radius: 12px;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .country-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .country-header:hover::before {
            left: 100%;
        }

        .country-header:hover {
            transform: translateX(8px) scale(1.02);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .country-flag {
            margin-right: 12px;
            font-size: 1.4em;
            filter: drop-shadow(0 0 5px rgba(255,255,255,0.5));
        }

        .channel-count {
            margin-left: auto;
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 500;
        }

        .channels-container {
            max-height: 450px;
            overflow-y: auto;
            border-radius: 12px;
            padding: 12px;
        }

        .channels-container::-webkit-scrollbar {
            width: 8px;
        }

        .channels-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .channels-container::-webkit-scrollbar-thumb {
            background: var(--accent-color);
            border-radius: 4px;
        }

        .channel-item {
            padding: 10px 15px;
            margin: 3px 0;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            border-left: 3px solid transparent;
        }

        .channel-item:hover {
            background: rgba(0, 212, 170, 0.2);
            transform: translateX(5px);
            border-left-color: var(--accent-color);
        }

        .channel-item.selected {
            background: rgba(0, 212, 170, 0.3);
            border-left-color: var(--accent-color);
            box-shadow: 0 4px 15px rgba(0, 212, 170, 0.3);
        }

        .channel-logo {
            width: 28px;
            height: 28px;
            margin-right: 12px;
            border-radius: 6px;
            object-fit: cover;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .channel-category {
            margin-left: auto;
            font-size: 0.75em;
            background: rgba(255, 255, 255, 0.15);
            padding: 3px 8px;
            border-radius: 10px;
            margin-right: 8px;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px;
            border-radius: 12px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
            color: white;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 20px rgba(0, 212, 170, 0.3);
        }

        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .control-button {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 10px 18px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
        }

        .control-button:hover {
            background: rgba(0, 212, 170, 0.2);
            border-color: var(--accent-color);
            transform: translateY(-2px);
        }

        .stats-container {
            background: var(--secondary-bg);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 1rem;
            text-align: center;
            font-size: 14px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .floating-upload {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
        }

        .upload-button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--accent-color), var(--accent-hover));
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(0, 212, 170, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .upload-button:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 35px rgba(0, 212, 170, 0.6);
        }

        .custom-channels-header {
            background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
            color: white;
            padding: 12px 18px;
            border-radius: 12px;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .custom-channels-header:hover {
            transform: translateX(8px) scale(1.02);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 24px;
            border-radius: 12px;
            color: white;
            font-weight: 500;
            z-index: 1001;
            opacity: 0;
            transform: translateX(100px);
            transition: all 0.3s ease;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification.success {
            background: linear-gradient(45deg, var(--success-color), #00b894);
        }

        .notification.error {
            background: linear-gradient(45deg, var(--error-color), #d63031);
        }

        @media (max-width: 1024px) {
            .floating-upload {
                bottom: 20px;
                right: 20px;
            }
            
            .upload-button {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">
    <header class="mb-8 text-center">
        <h1 class="text-5xl font-bold mb-3 neon-text">Morettiflix</h1>
        <p class="text-lg text-gray-300">Miles de canales internacionales en vivo</p>
        <div class="mt-2 text-sm text-gray-400">
            <span class="status-indicator status-online"></span>
            Conexión segura HTTPS
        </div>
    </header>

    <main class="w-full max-w-7xl px-4">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Panel de Canales -->
            <div class="lg:col-span-1">
                <div class="glass-effect p-4 mb-4">
                    <input type="text" id="searchInput" class="search-input" placeholder="🔍 Buscar canales...">
                </div>
                
                <div class="flex flex-wrap gap-2 mb-4">
                    <button class="control-button" onclick="showAllChannels()">📺 Todos</button>
                    <button class="control-button" onclick="showFavorites()">⭐ Favoritos</button>
                    <button class="control-button" onclick="showCustomChannels()">🎯 Personalizados</button>
                    <button class="control-button" onclick="refreshChannels()">🔄 Actualizar</button>
                </div>

                <div class="stats-container glass-effect">
                    <div id="statsInfo">Cargando canales...</div>
                </div>

                <div id="channelsPanel" class="channels-container glass-effect">
                    <div class="text-center text-gray-400">
                        <div class="loading-spinner"></div>
                        Cargando canales internacionales...
                    </div>
                </div>
            </div>

            <!-- Panel de Video -->
            <div class="lg:col-span-2">
                <div id="channelDescription" class="glass-effect p-4 mb-4 text-sm"></div>

                <div class="video-container">
                    <video id="video" controls class="w-full" preload="metadata" poster="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 300'%3E%3Crect width='400' height='300' fill='%23000'/%3E%3Ctext x='200' y='150' text-anchor='middle' fill='%2300d4aa' font-size='24' font-weight='bold'%3ESelecciona un canal%3C/text%3E%3C/svg%3E"></video>
                    <div id="errorOverlay" class="error-overlay" style="display: none;">
                        <div>
                            <h3 class="text-2xl font-bold mb-3">⚠️ Error de Reproducción</h3>
                            <p id="errorMessage" class="text-gray-300 mb-6">Problema al cargar el canal</p>
                            <div class="loading-spinner" id="loadingSpinner" style="display: none;"></div>
                            <div class="flex flex-wrap justify-center gap-3">
                                <button class="modern-button" onclick="retryCurrentChannel()">🔄 Reintentar</button>
                                <button class="modern-button" onclick="tryNextChannel()">⏭️ Siguiente</button>
                                <button class="modern-button" onclick="tryRandomChannel()">🎲 Aleatorio</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Botón flotante para cargar canales personalizados -->
    <div class="floating-upload">
        <button class="upload-button" onclick="document.getElementById('customChannelsFile').click()" title="Cargar canales personalizados">
            📁
        </button>
        <input type="file" id="customChannelsFile" accept=".m3u,.txt,.json" style="display: none;" onchange="loadCustomChannels(event)">
    </div>

    <!-- Notificaciones -->
    <div id="notification" class="notification"></div>

    <script>
        // Variables globales
        const video = document.getElementById('video');
        const channelsPanel = document.getElementById('channelsPanel');
        const channelDescription = document.getElementById('channelDescription');
        const errorOverlay = document.getElementById('errorOverlay');
        const errorMessage = document.getElementById('errorMessage');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const searchInput = document.getElementById('searchInput');
        const statsInfo = document.getElementById('statsInfo');
        const notification = document.getElementById('notification');

        let allChannels = [];
        let customChannels = [];
        let channelsByCountry = {};
        let filteredChannels = [];
        let currentChannel = null;
        let currentHls = null;
        let retryCount = 0;
        let currentView = 'all'; // 'all', 'favorites', 'custom'
        
        // Recuperar favoritos del localStorage
        let favorites = JSON.parse(localStorage.getItem('morettiflix_favorites') || '[]');
        
        const maxRetries = 3;
        const LOAD_TIMEOUT = 15000;
        const RETRY_DELAY = 2000;

        // Información de países
        const countryInfo = {
            'ar': { name: 'Argentina', flag: '🇦🇷' },
            'bo': { name: 'Bolivia', flag: '🇧🇴' },
            'br': { name: 'Brasil', flag: '🇧🇷' },
            'cl': { name: 'Chile', flag: '🇨🇱' },
            'co': { name: 'Colombia', flag: '🇨🇴' },
            'cr': { name: 'Costa Rica', flag: '🇨🇷' },
            'cu': { name: 'Cuba', flag: '🇨🇺' },
            'do': { name: 'Rep. Dominicana', flag: '🇩🇴' },
            'ec': { name: 'Ecuador', flag: '🇪🇨' },
            'es': { name: 'España', flag: '🇪🇸' },
            'gt': { name: 'Guatemala', flag: '🇬🇹' },
            'hn': { name: 'Honduras', flag: '🇭🇳' },
            'mx': { name: 'México', flag: '🇲🇽' },
            'ni': { name: 'Nicaragua', flag: '🇳🇮' },
            'pa': { name: 'Panamá', flag: '🇵🇦' },
            'pe': { name: 'Perú', flag: '🇵🇪' },
            'pr': { name: 'Puerto Rico', flag: '🇵🇷' },
            'py': { name: 'Paraguay', flag: '🇵🇾' },
            'sv': { name: 'El Salvador', flag: '🇸🇻' },
            'uy': { name: 'Uruguay', flag: '🇺🇾' },
            've': { name: 'Venezuela', flag: '🇻🇪' },
            'us': { name: 'Estados Unidos', flag: '🇺🇸' }
        };

        // Función para mostrar notificaciones
        function showNotification(message, type = 'success') {
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Función para cargar canales desde IPTV-org (usando HTTPS)
        async function loadChannels() {
            try {
                updateStats('Descargando lista de canales...');
                
                // Usar un proxy CORS o la API directa de GitHub
                const response = await fetch('https://api.allorigins.win/get?url=' + encodeURIComponent('https://iptv-org.github.io/iptv/languages/spa.m3u'), {
                    cache: 'no-cache'
                });
                
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                const m3uContent = data.contents;
                parseM3UContent(m3uContent);
                organizeChannelsByCountry();
                showAllChannels();
                showNotification('Canales cargados correctamente', 'success');
                
            } catch (error) {
                console.error('Error loading channels:', error);
                showNotification('Error cargando canales', 'error');
                updateStats('Error cargando canales');
                
                // Intentar con una fuente alternativa
                try {
                    await loadFallbackChannels();
                } catch (fallbackError) {
                    console.error('Fallback también falló:', fallbackError);
                }
            }
        }

        // Función de respaldo para cargar canales
        async function loadFallbackChannels() {
            showNotification('Intentando fuente alternativa...', 'success');
            
            // Canales de ejemplo codificados
            const fallbackM3U = `#EXTM3U
#EXTINF:-1 tvg-logo="https://i.imgur.com/example.png" group-title="Noticias" tvg-country="mx",Canal de Ejemplo
https://example-stream.m3u8
#EXTINF:-1 tvg-logo="" group-title="Entretenimiento" tvg-country="es",Otro Canal
https://another-example.m3u8`;
            
            parseM3UContent(fallbackM3U);
            organizeChannelsByCountry();
            showAllChannels();
            updateStats('Canales de ejemplo cargados');
        }

        // Función para cargar canales personalizados
        async function loadCustomChannels(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const text = await file.text();
                
                if (file.name.endsWith('.json')) {
                    // Formato JSON personalizado
                    const jsonData = JSON.parse(text);
                    customChannels = jsonData.channels || jsonData;
                } else {
                    // Formato M3U
                    customChannels = [];
                    parseM3UContent(text, true);
                }
                
                showNotification(`${customChannels.length} canales personalizados cargados`, 'success');
                
                // Guardar en localStorage para persistencia
                localStorage.setItem('morettiflix_custom_channels', JSON.stringify(customChannels));
                
                // Mostrar canales personalizados
                showCustomChannels();
                
            } catch (error) {
                console.error('Error loading custom channels:', error);
                showNotification('Error cargando canales personalizados', 'error');
            }
        }

        // Función para parsear contenido M3U
        function parseM3UContent(content, isCustom = false) {
            const channels = isCustom ? customChannels : allChannels;
            if (!isCustom) channels.length = 0;
            
            const lines = content.split('\n');
            let currentChannel = null;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                if (line.startsWith('#EXTINF:')) {
                    currentChannel = parseExtInf(line);
                } else if (line && !line.startsWith('#') && currentChannel) {
                    currentChannel.url = line;
                    if (isValidChannel(currentChannel)) {
                        channels.push({ ...currentChannel, isCustom: isCustom });
                    }
                    currentChannel = null;
                }
            }
            
            if (!isCustom) {
                // Filtrar duplicados
                const uniqueUrls = new Set();
                allChannels = allChannels.filter(channel => {
                    if (uniqueUrls.has(channel.url)) return false;
                    uniqueUrls.add(channel.url);
                    return true;
                });
                
                console.log(`Cargados ${allChannels.length} canales únicos`);
            } else {
                console.log(`Cargados ${customChannels.length} canales personalizados`);
            }
        }

        // Función para parsear línea EXTINF
        function parseExtInf(line) {
            const channel = {
                name: '',
                logo: '',
                group: '',
                country: '',
                category: '',
                url: ''
            };
            
            const logoMatch = line.match(/tvg-logo="([^"]*)"/);
            const groupMatch = line.match(/group-title="([^"]*)"/);
            const countryMatch = line.match(/tvg-country="([^"]*)"/);
            const nameMatch = line.match(/,(.*)$/);
            
            if (logoMatch) channel.logo = logoMatch[1];
            if (groupMatch) channel.group = groupMatch[1];
            if (countryMatch) {
                const countries = countryMatch[1].toLowerCase().split(';');
                channel.country = countries[0] || '';
            }
            if (nameMatch) channel.name = nameMatch[1].trim();
            
            channel.category = channel.group || 'General';
            
            return channel;
        }

        // Función para validar canal
        function isValidChannel(channel) {
            return channel.name && 
                   channel.url && 
                   channel.url.startsWith('http') &&
                   !channel.name.toLowerCase().includes('test') &&
                   channel.name.length > 1;
        }

        // Función para organizar canales por país
        function organizeChannelsByCountry() {
            channelsByCountry = {};
            
            allChannels.forEach(channel => {
                const countryCode = channel.country || 'unknown';
                if (!channelsByCountry[countryCode]) {
                    channelsByCountry[countryCode] = [];
                }
                channelsByCountry[countryCode].push(channel);
            });
            
            // Ordenar canales dentro de cada país
            Object.keys(channelsByCountry).forEach(country => {
                channelsByCountry[country].sort((a, b) => a.name.localeCompare(b.name));
            });
        }

        // Función para mostrar todos los canales
        function showAllChannels() {
            currentView = 'all';
            filteredChannels = allChannels;
            renderChannelsPanel(allChannels);
            updateStats();
        }

        // Función para mostrar favoritos
        function showFavorites() {
            currentView = 'favorites';
            const favoriteChannels = allChannels.filter(ch => favorites.includes(ch.url));
            filteredChannels = favoriteChannels;
            renderFavoriteChannels();
            updateStats(true);
        }

        // Función para mostrar canales personalizados
        function showCustomChannels() {
            currentView = 'custom';
            filteredChannels = customChannels;
            renderCustomChannels();
            updateStats(false, customChannels.length, 'personalizados');
        }

        // Función para renderizar favoritos
        function renderFavoriteChannels() {
            channelsPanel.innerHTML = '';
            
            if (favorites.length === 0) {
                channelsPanel.innerHTML = `
                    <div class="text-center text-gray-400 py-8">
                        <div class="text-4xl mb-4">⭐</div>
                        <p>No tienes canales favoritos aún.</p>
                        <p class="text-sm mt-2">Haz clic en la estrella de cualquier canal para agregarlo a favoritos.</p>
                    </div>
                `;
                return;
            }

            const favoriteChannels = allChannels.filter(ch => favorites.includes(ch.url));
            
            if (favoriteChannels.length === 0) {                channelsPanel.innerHTML = `
                    <div class="text-center text-gray-400 py-8">
                        <div class="text-4xl mb-4">📡</div>
                        <p>No se encontraron canales favoritos disponibles.</p>
                    </div>
                `;
                return;
            }

            renderChannelsPanel(favoriteChannels);
        }

        // Función para renderizar canales personalizados
        function renderCustomChannels() {
            channelsPanel.innerHTML = '';
            if (customChannels.length === 0) {
                channelsPanel.innerHTML = `
                    <div class="text-center text-gray-400 py-8">
                        <div class="text-4xl mb-4">📁</div>
                        <p>No has cargado ningún canal personalizado.</p>
                    </div>
                `;
                return;
            }

            renderChannelsPanel(customChannels);
        }

        // Función para actualizar estadísticas
        function updateStats(isFavorite = false, count = 0, label = '') {
            let total = count || filteredChannels.length;
            statsInfo.textContent = `${total} canales ${label || (isFavorite ? 'favoritos' : 'disponibles')}`;
        }

        // Función para renderizar el panel de canales
        function renderChannelsPanel(channels) {
            channelsPanel.innerHTML = '';

            channels.forEach((channel, index) => {
                const item = document.createElement('div');
                item.className = 'channel-item';
                item.onclick = () => playChannel(channel);

                const logo = channel.logo
                    ? `<img src="${channel.logo}" class="channel-logo" alt="Logo">`
                    : `<div class="channel-logo bg-gray-700 flex items-center justify-center text-xs text-white">TV</div>`;

                const favIcon = favorites.includes(channel.url)
                    ? '⭐'
                    : '☆';

                item.innerHTML = `
                    ${logo}
                    <span class="truncate">${channel.name}</span>
                    <span class="channel-category">${channel.category}</span>
                    <span onclick="toggleFavorite('${channel.url}'); event.stopPropagation();" title="Favorito">${favIcon}</span>
                `;

                channelsPanel.appendChild(item);
            });
        }

        // Función para reproducir un canal
        function playChannel(channel) {
            currentChannel = channel;
            channelDescription.innerHTML = `<strong>${channel.name}</strong> - ${channel.category}`;
            errorOverlay.style.display = 'none';
            video.pause();
            video.src = '';

            if (currentHls) {
                currentHls.destroy();
                currentHls = null;
            }

            if (Hls.isSupported()) {
                currentHls = new Hls();
                currentHls.loadSource(channel.url);
                currentHls.attachMedia(video);

                let loadTimeout = setTimeout(() => {
                    currentHls.destroy();
                    showError('Tiempo de espera agotado al cargar el canal');
                }, LOAD_TIMEOUT);

                currentHls.on(Hls.Events.MANIFEST_PARSED, () => {
                    clearTimeout(loadTimeout);
                    video.play();
                });

                currentHls.on(Hls.Events.ERROR, (event, data) => {
                    if (data.fatal) {
                        showError('Error fatal al reproducir el canal');
                    }
                });
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                video.src = channel.url;
                video.addEventListener('loadedmetadata', () => {
                    video.play();
                });
            } else {
                showError('Este navegador no soporta HLS');
            }
        }

        // Función para mostrar error
        function showError(message) {
            errorMessage.textContent = message;
            errorOverlay.style.display = 'flex';
        }

        // Funciones para cambiar de canal tras error
        function retryCurrentChannel() {
            if (currentChannel && retryCount < maxRetries) {
                retryCount++;
                loadingSpinner.style.display = 'block';
                setTimeout(() => {
                    loadingSpinner.style.display = 'none';
                    playChannel(currentChannel);
                }, RETRY_DELAY);
            } else {
                showNotification('Límite de reintentos alcanzado', 'error');
            }
        }

        function tryNextChannel() {
            const index = filteredChannels.findIndex(c => c.url === currentChannel.url);
            if (index !== -1 && index + 1 < filteredChannels.length) {
                playChannel(filteredChannels[index + 1]);
            } else {
                showNotification('No hay más canales en la lista', 'error');
            }
        }

        function tryRandomChannel() {
            if (filteredChannels.length > 0) {
                const randomIndex = Math.floor(Math.random() * filteredChannels.length);
                playChannel(filteredChannels[randomIndex]);
            }
        }

        // Buscar canales
        searchInput.addEventListener('input', () => {
            const term = searchInput.value.toLowerCase();
            let list = [];

            if (currentView === 'all') list = allChannels;
            else if (currentView === 'custom') list = customChannels;
            else if (currentView === 'favorites') list = allChannels.filter(ch => favorites.includes(ch.url));

            filteredChannels = list.filter(channel =>
                channel.name.toLowerCase().includes(term) ||
                channel.category.toLowerCase().includes(term)
            );

            renderChannelsPanel(filteredChannels);
        });

        // Marcar/desmarcar favorito
        function toggleFavorite(url) {
            const index = favorites.indexOf(url);
            if (index === -1) {
                favorites.push(url);
                showNotification('Agregado a favoritos');
            } else {
                favorites.splice(index, 1);
                showNotification('Eliminado de favoritos');
            }
            localStorage.setItem('morettiflix_favorites', JSON.stringify(favorites));
            if (currentView === 'favorites') showFavorites();
        }

        // Cargar canales al iniciar
        window.onload = () => {
            const storedCustom = localStorage.getItem('morettiflix_custom_channels');
            if (storedCustom) {
                try {
                    customChannels = JSON.parse(storedCustom);
                } catch (e) {
                    customChannels = [];
                }
            }
            loadChannels();
        };
    </script>
</body>
</html>
